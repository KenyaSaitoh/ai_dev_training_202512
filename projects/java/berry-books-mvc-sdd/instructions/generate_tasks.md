# タスク分解インストラクション

## 使用方法

```
@instructions/generate_tasks.md このインストラクションに従って、
プロジェクトルート: @<プロジェクトルートのパス>
SPEC: @<SPEC配置ディレクトリのパス>
から実装タスクリストを生成してください。

タスクリストは <プロジェクトルート>/tasks/ ディレクトリに複数ファイルとして保存してください。
```

**例（ベースプロジェクト）:**
```
@instructions/generate_tasks.md このインストラクションに従って、
プロジェクトルート: @projects/java/berry-books-mvc-sdd
SPEC: @projects/java/berry-books-mvc-sdd/specs/baseline/system/
から実装タスクリストを生成してください。

タスクリストは projects/java/berry-books-mvc-sdd/tasks/ ディレクトリに複数ファイルとして保存してください。
```

**例（拡張）:**
```
@instructions/generate_tasks.md このインストラクションに従って、
プロジェクトルート: @projects/java/berry-books-mvc-sdd
SPEC: @projects/java/berry-books-mvc-sdd/specs/enhancements/202512_inventory_alert/
から実装タスクリストを生成してください。

タスクリストは projects/java/berry-books-mvc-sdd/specs/enhancements/202512_inventory_alert/tasks/ ディレクトリに保存してください。
```

---

## 概要

このインストラクションは、完成したSPECから**複数人が並行して作業できる**実装タスクリストを生成するためのものです。

**重要な方針:**
- タスクリストは**抽象度の高いレベル**で作成します
- **ソースコードや詳細な実装手順は含めません**
- 各タスクは「何を作成・修正するか」を明確に示します
- 詳細な実装は次の「実装フェーズ（コード生成）」で仕様書を参照して行います

**出力先:**
- **ベースプロジェクトの場合**: `<プロジェクトルート>/tasks/` ディレクトリ
- **拡張の場合**: `<SPEC配置ディレクトリ>/tasks/` ディレクトリ
- **重要**: プロジェクトルートは必ず外部から指定されます

---

## 1. 設計ドキュメントの分析

引数として提供されたコンテキストに基づいて、以下の設計ドキュメントをロードして分析してください：

**注意:** プロジェクトルートは外部から明示的に指定されます。全てのパスはそのプロジェクトルートを基準とした相対パスです。

### プロジェクト憲章（最優先で確認）
- **memory/** - プロジェクトの開発原則、アーキテクチャ方針、品質基準、組織標準を確認
  - `constitution.md` - プロジェクト開発憲章
  - その他、組織やチームで共通的に使われる憲章ファイル
  - **重要**: タスク生成においても、憲章に記載された原則（テストカバレッジ基準、アーキテクチャパターン、コーディング規約など）を遵守すること

### 必須ドキュメント
- **requirements.md** - 機能概要と成功基準を確認
- **architecture_design.md** - 技術スタック、アーキテクチャ、ライブラリを確認
- **functional_design.md** - クラス設計と機能フローを確認

### オプションドキュメント（存在する場合）
- **data_model.md** - エンティティとデータベーススキーマを確認
- **screen_design.md** - UI画面とレイアウトを確認
- **behaviors.md** - 受入基準（Given-When-Then）を確認
- **external_interface.md** - 外部連携とAPI仕様（OpenAPI YAML含む）を確認
- **features/** - 個別機能の詳細設計を確認

**注意:** プロジェクトによって利用可能なドキュメントは異なります。利用可能なものに基づいてタスクを生成してください。

---

## 2. タスクファイルの分割構造

**出力先の決定:**
- **ベースプロジェクトの場合**: `<プロジェクトルート>/tasks/` ディレクトリ
- **拡張の場合**: `<SPEC配置ディレクトリ>/tasks/` ディレクトリ

**重要:** 
- プロジェクトルートは外部から明示的に指定されます
- ベースプロジェクトのタスクは `<プロジェクトルート>/tasks/` に配置
- 拡張のタスクは `<SPEC配置ディレクトリ>/tasks/` に配置（例: `specs/enhancements/202512_inventory_alert/tasks/`）

複数人が並行して作業できるように、以下のようにタスクファイルを分割して生成してください：

### 2.1 メインタスクリスト
**`tasks/tasks.md`** （指定された出力先に配置）
- プロジェクト全体の実行順序を示すメインタスクリスト
- 各タスクと担当者割り当ての概要
- 他のタスクファイルへのリンク集
- タスク間の依存関係を明示

### 2.2 セットアップタスク
**`tasks/setup_tasks.md`**
- プロジェクト初期化（全員が実行前に1回だけ）
- 開発環境セットアップ
- データベース初期化
- アプリケーションサーバー設定
- ログ設定

### 2.3 共通機能タスク
**`tasks/common_tasks.md`**
- 複数機能で共有される共通コンポーネント
- 共通エンティティ（例：User, Category等）
- 共通サービス（例：認証サービス、通知サービス等）
- 共通ユーティリティ（例：バリデーション、フォーマッター等）
- 認証/認可フィルター
- セッション管理

**注意**: 共通コンポーネントの具体的な内容は、プロジェクトのSPECから判断してください。

### 2.4 機能別タスク

**SPECから機能を抽出してタスクファイルを生成：**

#### 機能の識別と抽出
1. **機能の識別**
   - requirements.md、features/ ディレクトリ、functional_design.mdから機能を抽出
   - 各機能の範囲と責務を分析
   - 機能間の依存関係を把握

2. **タスクファイルの命名規則**
   - 基本形式：`tasks/[機能ID]_[機能名].md`
   - 例：`F_001_user_auth.md`、`F_002_inventory_management.md`
   - プロジェクトの機能ID規則に従う（存在する場合）
   - **注意**: ファイル名はアンダースコア区切りを使用

3. **各機能タスクファイルの内容**
   - 機能固有のクラスやモジュール
   - 機能固有のビジネスロジック
   - 機能固有のテストケース
   - **担当者:** 1名（機能ごとに独立して実装可能）

4. **機能分割の判断基準**
   - **小規模プロジェクト（1-3機能）**: 1つの`all_features.md`にまとめても可
   - **中規模プロジェクト（4-10機能）**: 機能ごとにファイル分割
   - **大規模プロジェクト（10+機能）**: 機能グループごとにディレクトリ分割も検討

### 2.5 結合テストタスク
**`tasks/integration_tasks.md`**
- 機能間結合テスト
- E2Eテスト（Playwright）- 画面遷移図（screen_design.md）に基づく主要フロー
- パフォーマンステスト
- 最終検証

---

## 3. タスク生成ルール

### 3.1 並行実行の判断基準

**[P]マークを付与する条件（並行実行可能）:**
- 異なるファイルを編集するタスク
- 異なるエンティティの実装
- 異なる機能の実装
- 独立したテストケース

**順次実行（[P]なし）が必要な条件:**
- 同じファイルを編集するタスク
- 依存関係があるタスク（Entity → Dao → Service → Bean の順序等）

### 3.2 タスクの粒度

**重要: タスクは抽象度の高いレベルで定義し、ソースコードは含めない**

各タスクは以下の粒度で分割：
- **Entity/Model**: 1エンティティまたはモデルクラスの作成/修正
- **Repository/Dao**: 1 Repository/Daoクラスの作成/修正
- **Service**: 1 Serviceクラスの作成/修正（複雑な場合は複数タスクに分割）
- **Controller/Bean**: 1 Controller/Beanクラスの作成/修正
- **View**: 1画面/ビューの作成/修正（HTML, JSP, XHTML, Template等）
- **Test**: 1テストクラスの作成/修正

**注意**: 上記の用語はプロジェクトの技術スタックに応じて読み替えてください。

**タスクの記述レベル:**
- 「何を作成・修正するか」を明確に記述
- 「どのような機能を実装するか」を簡潔に記述
- **ソースコードや詳細な実装手順は記述しない**
- 詳細な実装は次の「実装フェーズ（コード生成）」で行う

### 3.3 依存関係の順序付け

以下の順序でタスクを配置：

1. **セットアップ** (全ての前提)
   - 開発環境構築
   - プロジェクト初期化
   - データベース設定

2. **共通機能** (複数機能で共有)
   - 共通Entity/Model
   - 共通Utility/Helper
   - 共通Service
   - 認証/認可基盤

3. **機能別実装** (並行実行可能)
   - 一般的な実装順序: Entity/Model → Repository/Dao → Service → Controller/Bean → View
   - 各機能は独立して実装可能
   - **注意**: 実装順序はプロジェクトのアーキテクチャに従う

4. **結合テスト** (全機能実装後)
   - 機能間結合
   - E2Eテスト（Playwright）- 画面遷移図（screen_design.md）ベース
   - パフォーマンステスト

---

## 4. タスクファイルのフォーマット

各タスクファイルには以下の情報を含めてください：

### 4.1 ヘッダー情報
```markdown
# [タスクファイル名]

**担当者:** [想定人数と役割]
**推奨スキル:** [必要なスキルセット]
**想定工数:** [時間]
**依存タスク:** [前提となるタスクファイル]
```

### 4.2 タスクリスト
```markdown
- [ ] [P] **タスク X.X.X**: [タスク名]
  - **目的**: [このタスクで実現する機能・目的]
  - **対象**: [作成/修正するコンポーネント名やファイル名]
  - **参照SPEC**: [参照する仕様書セクション]
  - **注意事項**: [考慮すべき点があれば記載]
```

**タスクID命名規則:**
- タスクIDは**アンダースコア区切り**を使用します（例: `T_SETUP_001`, `T_F001_003`）
- **ハイフンは使用しません**（例: ~~`T-SETUP-001`~~, ~~`T-F001-003`~~）
- 形式: `T_[カテゴリ]_[連番]` または `T_[機能ID]_[連番]`

**記述例:**
```markdown
- [ ] **T_F001_003**: ProductDao の作成
  - **目的**: 商品情報の検索・取得機能を実装する
  - **対象**: ProductDao.java (または該当するRepositoryクラス)
  - **参照SPEC**: functional_design.md の ProductDao クラス設計
  - **注意事項**: カテゴリとの結合、フィルタリング条件を考慮すること
```

**注意: ソースコードや詳細な実装手順は記述しない**

### 4.3 並行実行ガイド
各タスクファイルに、そのファイル内で並行実行可能なタスクのグループを明示：

```markdown
## 並行実行可能なタスク

以下のタスクは並行して実行できます：
- タスク 3.1.1, 3.1.2, 3.1.3（異なるDaoクラス）
- タスク 4.2.1, 4.2.2, 4.2.3（異なるServiceクラス）
```

---

## 5. メインタスクリスト（tasks.md）の構造

プロジェクトルートの `tasks/tasks.md` は以下の構造で生成：

```markdown
# [プロジェクト名] - 実装タスクリスト

## 全体構成と担当割り当て

### タスク概要
| タスク | タスクファイル | 担当者 | 並行実行 | 想定工数 |
|---------|--------------|--------|---------|---------|
| 0. セットアップ | setup_tasks.md | 全員 | 不可 | [分析から算出] |
| 1. 共通機能 | common_tasks.md | 共通機能チーム | 一部可能 | [分析から算出] |
| 2. 機能1 | [id]_[name].md | 担当者A | 可能 | [分析から算出] |
| 3. 機能2 | [id]_[name].md | 担当者B | 可能 | [分析から算出] |
| ... | ... | ... | ... | ... |
| N. 結合テスト | integration_tasks.md | 全員 | 一部可能 | [分析から算出] |

### 実行順序
1. タスク0: セットアップ（全員で実行）
2. タスク1: 共通機能（共通機能チームが実装）
3. タスク2～N-1: 機能別実装（各担当者が並行実行） ← ここが並行化のポイント
4. タスクN: 結合テスト（全員で実施）

### タスクファイル一覧
- [セットアップタスク](setup_tasks.md)
- [共通機能タスク](common_tasks.md)
- [機能1のタスク]([id]_[name].md)
- [機能2のタスク]([id]_[name].md)
- ...
- [結合テストタスク](integration_tasks.md)

## 依存関係図
[Mermaid形式で依存関係を図示]
\```

**生成時の注意:**
- プロジェクト名はrequirements.mdから取得
- 機能の数、命名、分割方法はSPECから判断
- 想定工数は各タスクの複雑度分析から算出
- ファイル名はすべてアンダースコア区切りを使用

---

## 6. 成果物の要件

生成されるタスクファイルは以下の要件を満たす必要があります：

### 6.1 適切な抽象度
- 各タスクは「何を作成・修正するか」が明確に分かる抽象度で記述
- 作成/修正するコンポーネント名やファイル名を明示
- 参照する仕様書のセクションを明示
- **ソースコードや詳細な実装手順は含めない**
- 詳細な実装は次の「実装フェーズ（コード生成）」で仕様書を参照して行う

### 6.2 並行実行可能性
- [P]マークで並行実行可能なタスクを明示
- 依存関係を明確に記述
- 担当者割り当てを考慮

### 6.3 追跡可能性
- チェックボックス形式でタスクの進捗を追跡可能
- タスクIDを一意に付与（例: T_SETUP_001, T_COMMON_001, T_F001_001）
- **重要**: タスクIDは必ずアンダースコア区切りを使用し、ハイフンは使用しない

### 6.4 メンテナンス性
- 機能ごとにファイルを分割し、修正しやすい構造
- タスクの追加・削除が容易

---

## 7. 生成手順

以下の手順でタスクファイルを生成してください：

**注意:** 
- プロジェクトルートは外部から明示的に指定されます
- 全てのパスは指定されたプロジェクトルートを基準とした相対パスです
- タスクファイルの出力先も明示的に指定されます

1. **憲章確認**: `<プロジェクトルート>/memory/` 配下の憲章ファイルを読み込み、開発原則と品質基準を把握
   - テストカバレッジ基準、アーキテクチャパターン、コーディング規約などを確認
   - これらの原則はタスク生成全体を通して遵守する

2. **SPEC分析**: 全てのSPECファイルを読み込み、プロジェクト全体を把握
   - requirements.mdからプロジェクト概要と成功基準を確認
   - architecture_design.mdから技術スタックとアーキテクチャを確認
   - functional_design.mdからクラス設計と機能構成を確認

3. **機能抽出と分析**:
   - requirements.mdとfeatures/ディレクトリから実装が必要な機能を抽出
   - 各機能の範囲、責務、複雑度を分析
   - 機能間の依存関係を把握
   - 共通コンポーネント（複数機能で使用される要素）を識別

4. **タスク分割戦略の決定**:
   - 機能数と複雑度から適切なタスクファイル分割方法を判断
     - **小規模（1-3機能）**: 少数ファイルで管理
     - **中規模（4-10機能）**: 機能ごとにファイル分割
     - **大規模（10+機能）**: 機能グループ分割も検討
   - タスクファイル命名規則を決定（プロジェクトの規則に従う）

5. **タスク抽出**: 各SPECから実装タスクを抽象度の高いレベルで抽出
   - **注意**: ソースコードや詳細な実装手順は抽出しない
   - 「何を作成・修正するか」のみを抽出
   - 憲章の原則（例: ユニットテストの必須化）を考慮してタスクを構成

6. **分類**: タスクをセットアップ/共通機能/機能別/結合に分類

7. **順序付け**: 依存関係に基づいてタスクを順序付け

8. **並行化判定**: [P]マークを付与

9. **ファイル生成**: 各タスクファイルを指定された出力先ディレクトリに生成
   - **注意**: ソースコードを含めない
   - ファイル名はアンダースコア区切りを使用（ハイフンは使用しない）
   - タスクIDもアンダースコア区切りを使用（ハイフンは使用しない）
   - **重要**: 出力先は外部から明示的に指定されます（ベースプロジェクト: `<プロジェクトルート>/tasks/`、拡張: `<SPEC配置ディレクトリ>/tasks/`）

10. **メインリスト生成**: `tasks/tasks.md` に全体概要と実行計画を生成

---

## 8. 注意事項

- **プロジェクトルートの明示**: プロジェクトルートとSPEC配置ディレクトリは必ず外部から明示的に指定されます
- **出力先の確認**: タスクファイルの出力先は外部から指定されます（ベースプロジェクト: `<プロジェクトルート>/tasks/`、拡張: `<SPEC配置ディレクトリ>/tasks/`）
- **命名規則の統一**: 
  - タスクファイル名は**アンダースコア区切り**を使用（例: `setup_tasks.md`, `F_001_user_auth.md`）
  - タスクIDも**アンダースコア区切り**を使用（例: `T_SETUP_001`, `T_F001_003`）
  - **ハイフンは使用しない**（ファイル名、タスクID共に）
- **憲章の遵守**: `<プロジェクトルート>/memory/` 配下の憲章ファイルに記載された開発原則、品質基準、組織標準を必ず遵守すること
  - 例: テストカバレッジ基準に従ったテストタスクの配置
  - 例: アーキテクチャパターンに準拠したコンポーネント分割
- **抽象度の維持**: タスクは「何を作るか」を示すレベルに留め、ソースコードや詳細な実装手順は記述しない
- **実装フェーズとの分離**: 詳細な実装は次の「実装フェーズ（コード生成）」で行われることを前提とする
- **既存コードの考慮**: 既存の実装がある場合、修正タスクと新規作成タスクを明確に区別
- **機能間の依存**: 機能間で共有されるコンポーネントは「共通機能」に配置
- **テストの配置**: ユニットテストは各機能別タスクに含め、E2Eテスト（Playwright）と結合テストは結合タスクに配置
  - E2Eテストは画面遷移図（screen_design.md）の各フローをテストケース化
- **柔軟性**: プロジェクトの規模や構造に応じて、タスクファイルの分割数を調整可能

