# berry-books - 振る舞い仕様書（概要）

**プロジェクトID:** berry-books  
**バージョン:** 1.1.0  
**Last Updated:** 2025-12-16  
**ステータス:** 受入基準詳細化

---

## 概要

このドキュメントは、berry-booksシステムの外形的な振る舞いの概要を定義する。
各シナリオはGiven-When-Then形式で記述され、ブラックボックステストの基礎となる。

各機能の詳細な振る舞い仕様は、機能ごとに分割されたドキュメントを参照してください。

**関連ドキュメント:**
- [requirements.md](requirements.md) - ビジネス要件（What & Why）
- [functional_design.md](functional_design.md) - 機能設計（Flows & UI）
- [architecture_design.md](architecture_design.md) - アーキテクチャ設計
- [data_model.md](data_model.md) - データモデル
- [tasks.md](tasks.md) - 実装タスク

---

## 画面マッピング

このドキュメントで参照する画面とファイル名の対応：

| 画面ID | 画面名 | ファイル名 | 認証要否 |
|--------|--------|-----------|---------|
| SC-001 | ログイン画面 | index.xhtml | 不要 |
| SC-002 | 新規登録画面 | customerInput.xhtml | 不要 |
| SC-003 | 登録完了画面 | customerOutput.xhtml | 不要 |
| SC-004 | 書籍検索画面 | bookSearch.xhtml | 必要 |
| SC-005 | 検索結果画面 | bookSelect.xhtml | 必要 |
| SC-006 | カート画面 | cartView.xhtml | 必要 |
| SC-007 | 注文入力画面 | bookOrder.xhtml | 必要 |
| SC-008 | 注文完了画面 | orderSuccess.xhtml | 必要 |
| SC-009 | 注文エラー画面 | orderError.xhtml | 必要 |
| SC-010 | 注文履歴画面 | orderHistory.xhtml | 必要 |
| SC-011 | 注文詳細画面 | orderDetail.xhtml | 必要 |

---

## 機能別シナリオ一覧

### F-001: 書籍検索・閲覧

**詳細:** [../features/F-001-book-search/behaviors.md](../features/F-001-book-search/behaviors.md)

- Scenario 1: カテゴリで書籍を絞り込む
- Scenario 2: キーワードで書籍を検索する
- Scenario 3: カテゴリとキーワードを組み合わせて検索する
- Scenario 4: 在庫なしの書籍も表示される

### F-002: ショッピングカート管理

**詳細:** [../features/F-002-shopping-cart/behaviors.md](../features/F-002-shopping-cart/behaviors.md)

- Scenario 1: 書籍をカートに追加する
- Scenario 2: カート内の書籍を削除する
- Scenario 3: カート全体をクリアする
- Scenario 4: 同じ書籍を複数回追加する

### F-003: 注文処理

**詳細:** [../features/F-003-order-processing/behaviors.md](../features/F-003-order-processing/behaviors.md)

- Scenario 1: 注文を確定する（正常系）
- Scenario 2: 在庫不足エラー（異常系）
- Scenario 3: 同時注文による競合（楽観的ロック）
- Scenario 4: 配送料金の自動計算（通常）
- Scenario 5: 沖縄県への配送料金
- Scenario 6: 送料無料（5000円以上）

### F-004: 顧客管理・認証

**詳細:** [../features/F-004-customer-auth/behaviors.md](../features/F-004-customer-auth/behaviors.md)

- Scenario 1: 新規顧客登録（正常系）
- Scenario 2: メールアドレス重複エラー（異常系）
- Scenario 3: ログイン（正常系）
- Scenario 4: ログイン失敗（異常系）
- Scenario 5: 未ログインユーザーのアクセス制限
- Scenario 6: ログアウト

### F-005: 注文履歴参照

**詳細:** [../features/F-005-order-history/behaviors.md](../features/F-005-order-history/behaviors.md)

- Scenario 1: 注文履歴一覧を表示する
- Scenario 2: 注文詳細を表示する
- Scenario 3: 注文履歴が空の場合

---

## 例外・エラーシナリオ

### 在庫管理

| シナリオ | 期待される動作 | エラーコード | 詳細ドキュメント |
|----------|-------------------|-------------|-----------------|
| 在庫0の書籍を検索 | 検索結果に表示（BR-004）、「カートへ」ボタン無効化 | - | F-001 |
| カート追加後に在庫0になった | 注文確定時に在庫不足エラー | BIZ-003 | F-003 |
| 複数ユーザーが同時購入 | 先着順成功、後続ユーザーはOptimisticLockException | BIZ-004 | F-003 |
| 在庫数より多い数量を注文 | 注文確定時にエラー、カート保持 | BIZ-003 | F-003 |
| マイナス数量でカート追加 | クライアント検証エラー | VAL-004 | F-002 |
| 0数量でカート追加 | クライアント検証エラー | VAL-004 | F-002 |

### 認証・セッション

| シナリオ | 期待される動作 | エラーコード | 詳細ドキュメント |
|----------|-------------------|-------------|-----------------|
| セッションタイムアウト（60分） | ログイン画面にリダイレクト | - | F-004 |
| 直接URL入力（未ログイン） | AuthenticationFilterでログイン画面にリダイレクト（BR-034） | - | F-004 |
| ログアウト後のブラウザバック | AuthenticationFilterでログイン画面にリダイレクト | - | F-004 |
| 重複ログイン | 最新のセッションのみ有効（古いセッションは無効化） | - | F-004 |
| 不正なメールアドレスでログイン | 認証失敗 | BIZ-002 | F-004 |
| パスワード未入力でログイン | クライアント検証エラー | VAL-002 | F-004 |
| メールアドレス未入力でログイン | クライアント検証エラー | VAL-001 | F-004 |

### カート操作

| シナリオ | 期待される動作 | エラーコード | 詳細ドキュメント |
|----------|-------------------|-------------|-----------------|
| 空カートで注文画面へ遷移 | エラーメッセージ表示、注文画面に遷移しない | BIZ-005 | F-002 |
| カート内の書籍がデータベースから削除された | 注文時にエラー（書籍が見つからない） | SYS-001 | F-002 |
| カート内の価格が変更された | カート追加時の価格で注文（CartItemに保存済み） | - | F-002 |
| セッション内のカートが破損 | システムエラー | SYS-001 | F-002 |
| 同じ書籍を最大在庫数以上カート追加 | クライアント検証または注文時エラー | BIZ-003 | F-002 |

### 入力検証

| シナリオ | 期待される動作 | エラーコード | 詳細ドキュメント |
|----------|-------------------|-------------|-----------------|
| 顧客名未入力で登録 | クライアント検証エラー | VAL-001 | F-004 |
| メールアドレス形式不正で登録 | クライアント検証エラー | VAL-001 | F-004 |
| 配送先住所未入力で注文 | クライアント検証エラー | VAL-003 | F-003 |
| 決済方法未選択で注文 | クライアント検証エラー | - | F-003 |
| 重複メールアドレスで登録 | ビジネスロジックエラー（BR-030） | BIZ-001 | F-004 |

### 配送料金計算

| シナリオ | 期待される動作 | 計算ロジック | 詳細ドキュメント |
|----------|-------------------|-------------|-----------------|
| 購入金額4999円（東京都） | 配送料800円 | 5000円未満 & 非沖縄 | F-003 |
| 購入金額5000円（東京都） | 配送料0円（送料無料） | 5000円以上 | F-003 |
| 購入金額5001円（東京都） | 配送料0円（送料無料） | 5000円以上 | F-003 |
| 購入金額3000円（沖縄県） | 配送料1700円 | 5000円未満 & 沖縄 | F-003 |
| 購入金額5000円（沖縄県） | 配送料0円（送料無料） | 5000円以上優先 | F-003 |
| 購入金額3000円（大阪府） | 配送料800円 | 5000円未満 & 非沖縄 | F-003 |

---

## エラーメッセージ一覧

### 検証エラー（VAL-xxx）

| コード | メッセージ | 発生条件 |
|--------|-----------|---------|
| VAL-001 | {フィールド名}を入力してください | 必須フィールド未入力 |
| VAL-002 | パスワードを入力してください | パスワード未入力 |
| VAL-003 | 配送先住所を入力してください | 住所未入力 |
| VAL-004 | 数量は1以上を入力してください | 数量が0以下 |

### ビジネスエラー（BIZ-xxx）

| コード | メッセージ | 発生条件 | 例外クラス |
|--------|-----------|---------|-----------|
| BIZ-001 | メールアドレスが既に登録されています | メールアドレス重複（BR-030） | EmailAlreadyExistsException |
| BIZ-002 | メールアドレスまたはパスワードが正しくありません | 認証失敗 | - |
| BIZ-003 | 在庫が不足しています | 注文数 > 在庫数 | OutOfStockException |
| BIZ-004 | 他のユーザーが購入済みです。カートを確認してください | 楽観的ロック競合（BR-024） | OptimisticLockException |
| BIZ-005 | カートが空です | 空カートで注文試行 | - |

### システムエラー（SYS-xxx）

| コード | メッセージ | 発生条件 |
|--------|-----------|---------|
| SYS-001 | システムエラーが発生しました | 予期しないエラー |
| SYS-002 | データベース接続エラー | DB接続失敗 |
| SYS-003 | トランザクションエラー | トランザクション失敗 |

---

## ビジネスルール参照

### 検索機能（F-001）

| ルールID | 説明 |
|---------|-------------|
| BR-001 | カテゴリ未選択の場合、全カテゴリが検索対象 |
| BR-002 | キーワード未入力の場合、書籍名と著者の両方を検索 |
| BR-003 | 検索結果は書籍ID昇順でソート |
| BR-004 | 在庫0の書籍も表示（購入不可） |

### カート管理（F-002）

| ルールID | 説明 |
|---------|-------------|
| BR-010 | カート内容はセッション単位で保持（ログアウトまで） |
| BR-011 | 同じ書籍を追加した場合、数量を加算 |
| BR-012 | カート追加時点の在庫バージョン番号を保存（楽観的ロック用） |
| BR-013 | カート内の合計金額は常に自動計算 |

### 注文処理（F-003）

| ルールID | 説明 | 詳細 |
|---------|-------------|------|
| BR-020 | 配送料金計算ルール | 通常800円、沖縄県1700円、5000円以上無料 |
| BR-021 | 決済方法選択肢 | 銀行振込(1)、クレジットカード(2)、着払い(3) |
| BR-022 | 在庫チェックタイミング | 注文確定時に全書籍の在庫を確認 |
| BR-023 | 在庫減算タイミング | 在庫チェック後、注文登録前に減算 |
| BR-024 | 楽観的ロック制御 | カート追加時のバージョン番号で在庫更新 |
| BR-025 | トランザクション範囲 | 在庫チェック〜注文登録〜在庫減算は単一トランザクション |

### 顧客管理・認証（F-004）

| ルールID | 説明 |
|---------|-------------|
| BR-030 | メールアドレスは一意（重複不可） |
| BR-031 | パスワードは平文保存（学習用のみ、本番環境では非推奨） |
| BR-032 | セッションタイムアウト: 60分 |
| BR-033 | 公開ページ: ログイン画面、新規登録画面、登録完了画面 |
| BR-034 | 公開ページ以外は認証必須 |

### 注文履歴参照（F-005）

| ルールID | 説明 |
|---------|-------------|
| BR-040 | 注文履歴は顧客IDでフィルタリング |
| BR-041 | 注文日降順（新しい順）でソート |
| BR-042 | 注文詳細は注文IDで取得 |

---

## テスト実行チェックリスト

### 機能テスト

- [ ] **F-001: 書籍検索・閲覧**: 全4シナリオ実行
- [ ] **F-002: ショッピングカート管理**: 全4シナリオ実行
- [ ] **F-003: 注文処理**: 全6シナリオ実行（正常系、在庫不足、楽観的ロック、配送料金計算3パターン）
- [ ] **F-004: 顧客管理・認証**: 全6シナリオ実行
- [ ] **F-005: 注文履歴参照**: 全3シナリオ実行

### 例外・エラーテスト

- [ ] **在庫管理**: 全6ケース実行
- [ ] **認証・セッション**: 全7ケース実行
- [ ] **カート操作**: 全5ケース実行
- [ ] **入力検証**: 全5ケース実行
- [ ] **配送料金計算**: 全6ケース実行

### ブラウザ互換性テスト

- [ ] Chrome最新版
- [ ] Firefox最新版
- [ ] Edge最新版

### パフォーマンステスト

- [ ] 50同時ユーザーでの動作確認
- [ ] レスポンスタイム3秒以内の確認

---

## 機能別詳細ドキュメント

各機能の詳細な振る舞い仕様は、以下のドキュメントを参照してください。

### F-001: 書籍検索・閲覧
- [振る舞い仕様](../features/F-001-book-search/behaviors.md)

### F-002: ショッピングカート管理
- [振る舞い仕様](../features/F-002-shopping-cart/behaviors.md)

### F-003: 注文処理
- [振る舞い仕様](../features/F-003-order-processing/behaviors.md)

### F-004: 顧客管理・認証
- [振る舞い仕様](../features/F-004-customer-auth/behaviors.md)

### F-005: 注文履歴参照
- [振る舞い仕様](../features/F-005-order-history/behaviors.md)
