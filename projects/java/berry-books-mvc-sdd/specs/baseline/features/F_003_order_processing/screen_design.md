# F-003: 注文処理 - 画面設計書

**機能ID:** F-003  
**機能名:** 注文処理  
**バージョン:** 1.0.0  
**最終更新日:** 2025-12-16  
**フォーマット:** PlantUML (draw.io インポート可能)

---

## 画面一覧

1. [注文入力画面 (bookOrder.xhtml)](#1-注文入力画面)
2. [注文完了画面 (orderSuccess.xhtml)](#2-注文完了画面)
3. [注文エラー画面 (orderError.xhtml)](#3-注文エラー画面)

---

## 1. 注文入力画面

**ファイル名:** `bookOrder.xhtml`  
**目的:** 配送先・決済方法入力

### PlantUML

```plantuml
@startsalt
{
  <b>以下の内容で注文します</b>
  --
  {#
    . 顧客名     | Alice 様
    . 注文内容   | {#
                   . 書籍名                  | 金額   | 注文数
                   . Java SEディープダイブ    | 3,400 | 1
                   . SpringBoot in Cloud    | 3,000 | 1
                   . SQLの冒険～RDBの深層     | 2,200 | 1
                 }
    . 注文金額合計 | 8,600
    . 配送料金   | 800
    . 配送先住所 | "東京都渋谷区道玄坂1-2-3     "
    . 決済方法   | ( ) 銀行振り込み
                 | (X) クレジットカード
                 | ( ) 着払い
  }
  [  注文する（方式1）  ]  [  注文する（方式2）  ]
  買い物を続ける
}
@endsalt
```

### 画像表示ルール

注文入力画面では、書籍の画像は表示されません（テーブルのみ）。

### 配送料金計算ルール

```
IF 商品合計 >= 5,000円
  → 配送料 = 0円（送料無料）
ELSE IF 配送先住所 が "沖縄県" で始まる
  → 配送料 = 1,700円
ELSE
  → 配送料 = 800円
```

### 動作

- **買い物を続ける**: bookSelect.xhtmlへ遷移
- **注文する（方式1）**: `OrderBean.placeOrder1()` 
  - JavaScript確認ダイアログ表示
  - 成功 → orderSuccess.xhtml（リダイレクト、orderTranIdをパラメータで渡す）
  - 在庫不足 → orderError.xhtmlへ遷移（flash scopeでエラーメッセージ）
- **注文する（方式2）**: `OrderBean.placeOrder2()`
  - 方式1と異なる実装パターン（トランザクション管理の検証用）

---

## 2. 注文完了画面

**ファイル名:** `orderSuccess.xhtml`  
**目的:** 注文確定完了通知

### PlantUML

```plantuml
@startsalt
{
  <b>注文が成功しました</b>
  --
  注文ID：1001
  合計金額：8,600 円
  
  <b>注文内容</b>
  {#
    . 書籍名                  | 注文数 | 価格
    . Java SEディープダイブ    | 1     | 3,400 円
    . SpringBoot in Cloud    | 1     | 3,000 円
    . SQLの冒険～RDBの深層     | 1     | 2,200 円
  }
  注文履歴を表示する
  書籍の選択ページへ
  --
  [  ログアウト  ]
}
@endsalt
```

---

## 3. 注文エラー画面

**ファイル名:** `orderError.xhtml`  
**目的:** 注文エラー表示

### PlantUML

```plantuml
@startsalt
{
  <b>注文処理でエラーが発生しました</b>
  --
  [エラーメッセージ]
  在庫不足エラー：
  Java SEディープダイブの在庫が不足しています（在庫: 1, 注文: 2）
  --
  買い物を続ける
}
@endsalt
```

### エラーメッセージパターン

| エラー種別 | メッセージ |
|----------|----------|
| 在庫不足 | "在庫が不足しています。書籍名（在庫: X, 注文: Y）" |
| 楽観的ロック競合 | "他のユーザーが同時に購入しました。カートを確認してください。" |
| 空カート | "カートに商品がありません。" |

