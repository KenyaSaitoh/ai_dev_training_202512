# berry-books - 振る舞い仕様（Acceptance Criteria）

**Feature ID:** 001-berry-books  
**Version:** 1.0.0  
**Last Updated:** 2025-12-14  
**Status:** Extracted from spec.md

---

## 概要

このドキュメントは、berry-booksシステムの外形的な振る舞いを定義します。
各シナリオはGiven-When-Then形式で記述され、ブラックボックステストの基礎となります。

**関連ドキュメント:**
- [spec.md](spec.md) - ビジネス要件（What & Why）
- [plan.md](plan.md) - 技術実装計画（How）

---

## 機能 3.1: 書籍検索・閲覧

### Scenario: カテゴリで書籍を絞り込む

```gherkin
Given ユーザーが書籍検索画面にアクセスしている
When ユーザーがカテゴリ「Java」を選択して検索する
Then Java カテゴリの書籍一覧が表示される
And 各書籍には書籍名、著者、出版社、価格、在庫数が表示される
```

### Scenario: キーワードで書籍を検索する

```gherkin
Given ユーザーが書籍検索画面にアクセスしている
When ユーザーがキーワード「Spring」を入力して検索する
Then 書籍名または著者に「Spring」を含む書籍一覧が表示される
```

### Scenario: カテゴリとキーワードを組み合わせて検索する

```gherkin
Given ユーザーが書籍検索画面にアクセスしている
When ユーザーがカテゴリ「Java」とキーワード「Spring」を入力して検索する
Then Java カテゴリかつ「Spring」を含む書籍のみが表示される
```

### Scenario: 在庫なしの書籍も表示される

```gherkin
Given ユーザーが検索結果を閲覧している
When 在庫数が0の書籍が存在する
Then その書籍も検索結果に表示される
And 在庫数「0」が表示される
But カートへの追加はできない（グレーアウト）
```

---

## 機能 3.2: ショッピングカート管理

### Scenario: 書籍をカートに追加する

```gherkin
Given ユーザーが検索結果画面で書籍を閲覧している
When ユーザーが書籍を選択し、数量「2」を入力してカートに追加する
Then カート確認画面に遷移する
And カートに選択した書籍が数量「2」で表示される
And 合計金額が自動計算される
```

### Scenario: カート内の書籍を削除する

```gherkin
Given ユーザーがカート内に複数の書籍がある
When ユーザーが特定の書籍にチェックを入れて削除ボタンをクリックする
Then その書籍がカートから削除される
And 合計金額が再計算される
```

### Scenario: カート全体をクリアする

```gherkin
Given ユーザーがカート内に書籍がある
When ユーザーが「カートをクリア」ボタンをクリックする
Then 全ての書籍がカートから削除される
And 合計金額が0円になる
```

### Scenario: 同じ書籍を複数回追加する

```gherkin
Given ユーザーがカートに書籍A（数量2）を追加済み
When ユーザーが再度書籍A（数量3）を追加する
Then カート内の書籍Aの数量が「5」に更新される
And 価格も数量に応じて更新される
```

---

## 機能 3.3: 注文処理

### Scenario: 注文を確定する（正常系）

```gherkin
Given ユーザーがカート内に書籍がある状態で注文画面に遷移している
And 全ての書籍の在庫が十分にある
When ユーザーが配送先住所「東京都渋谷区...」を入力する
And 決済方法「クレジットカード」を選択する
And 「注文確定」ボタンをクリックする
Then 注文が確定される
And 注文IDが発行される
And 各書籍の在庫数が注文数分減少する
And カートがクリアされる
And 注文完了画面に遷移する
```

### Scenario: 在庫不足エラー（異常系）

```gherkin
Given ユーザーがカートに書籍A（数量5）を追加している
And 書籍Aの現在の在庫数が「3」である
When ユーザーが注文確定ボタンをクリックする
Then エラーメッセージ「在庫不足です」が表示される
And 注文は確定されない
And カートはクリアされない
```

### Scenario: 同時注文による競合（楽観的ロック）

```gherkin
Given ユーザーAとユーザーBが同じ書籍をカートに追加している（在庫5）
And ユーザーAが数量3、ユーザーBが数量3を注文しようとしている
When ユーザーAが先に注文を確定する（在庫5→2）
And ユーザーBが後から注文を確定しようとする
Then ユーザーBにエラーメッセージ「他のユーザーが同時に購入しました」が表示される
And ユーザーBの注文は確定されない
And ユーザーBはカートを再確認できる
```

### Scenario: 配送料金の自動計算

```gherkin
Given ユーザーが購入金額3000円のカートを確認している
When ユーザーが配送先住所「東京都」を入力する
Then 配送料金「800円」が表示される
And 総合計「3800円」が表示される
```

### Scenario: 沖縄県への配送料金

```gherkin
Given ユーザーが購入金額3000円のカートを確認している
When ユーザーが配送先住所「沖縄県那覇市」を入力する
Then 配送料金「1700円」が表示される
And 総合計「4700円」が表示される
```

### Scenario: 送料無料（5000円以上）

```gherkin
Given ユーザーが購入金額5500円のカートを確認している
When ユーザーが配送先住所「東京都」を入力する
Then 配送料金「0円（送料無料）」が表示される
And 総合計「5500円」が表示される
```

---

## 機能 3.4: 顧客管理・認証

### Scenario: 新規顧客登録（正常系）

```gherkin
Given ユーザーが新規登録画面にアクセスしている
When ユーザーが以下の情報を入力する
  | 項目 | 値 |
  | 顧客名 | 山田太郎 |
  | メールアドレス | yamada@example.com |
  | パスワード | password123 |
  | 生年月日 | 1990-01-01 |
  | 住所 | 東京都渋谷区... |
And 「登録」ボタンをクリックする
Then アカウントが作成される
And 登録完了画面に遷移する
```

### Scenario: メールアドレス重複エラー（異常系）

```gherkin
Given データベースに「yamada@example.com」のアカウントが既に存在する
When ユーザーが同じメールアドレス「yamada@example.com」で登録しようとする
Then エラーメッセージ「メールアドレスが既に使用されています」が表示される
And アカウントは作成されない
```

### Scenario: ログイン（正常系）

```gherkin
Given ユーザーが登録済みアカウントを持っている
When ユーザーがメールアドレス「yamada@example.com」とパスワード「password123」を入力してログインする
Then ログインが成功する
And 書籍検索画面に遷移する
And セッションにログイン状態が保存される
```

### Scenario: ログイン失敗（異常系）

```gherkin
Given ユーザーがログイン画面にアクセスしている
When ユーザーが誤ったパスワードを入力してログインしようとする
Then エラーメッセージ「メールアドレスまたはパスワードが正しくありません」が表示される
And ログインは成功しない
```

### Scenario: 未ログインユーザーのアクセス制限

```gherkin
Given ユーザーがログインしていない
When ユーザーが書籍検索画面にアクセスしようとする
Then ログイン画面にリダイレクトされる
```

### Scenario: ログアウト

```gherkin
Given ユーザーがログイン済みの状態
When ユーザーが「ログアウト」ボタンをクリックする
Then セッションが無効化される
And ログイン画面に遷移する
```

---

## 機能 3.5: 注文履歴参照

### Scenario: 注文履歴一覧を表示する

```gherkin
Given ユーザーがログイン済みで過去に3件の注文がある
When ユーザーが「注文履歴」メニューをクリックする
Then 注文履歴一覧が表示される
And 各注文には以下の情報が表示される
  | 項目 | 例 |
  | 注文ID | 1001 |
  | 注文日 | 2025-12-01 |
  | 配送先 | 東京都渋谷区... |
  | 決済方法 | クレジットカード |
  | 合計金額 | 3800円 |
```

### Scenario: 注文詳細を表示する

```gherkin
Given ユーザーが注文履歴一覧を閲覧している
When ユーザーが特定の注文をクリックする
Then 注文詳細画面に遷移する
And 注文明細（購入書籍、数量、単価）が表示される
And 配送料金と総合計が表示される
```

### Scenario: 注文履歴が空の場合

```gherkin
Given ユーザーがログイン済みだが注文履歴がない
When ユーザーが「注文履歴」メニューをクリックする
Then 「注文履歴はありません」というメッセージが表示される
```

---

## エッジケース＆エラーシナリオ

### 在庫管理

| シナリオ | 期待される動作 |
|----------|-------------------|
| 在庫0の書籍を検索 | 検索結果に表示、カート追加不可 |
| カート追加後に在庫0になった | 注文時に在庫不足エラー |
| 複数ユーザーが同時購入 | 先着順、後続ユーザーはエラー |
| 在庫数より多い数量を注文 | 注文確定時にエラー |

### 認証・セッション

| シナリオ | 期待される動作 |
|----------|-------------------|
| セッションタイムアウト | ログイン画面にリダイレクト |
| 直接URL入力（未ログイン） | ログイン画面にリダイレクト |
| ログアウト後のブラウザバック | ログイン画面にリダイレクト |
| 重複ログイン | 最新のセッションのみ有効 |

### カート操作

| シナリオ | 期待される動作 |
|----------|-------------------|
| 空カートで注文画面へ遷移 | エラーメッセージ表示 |
| カート内の書籍が削除された | 注文時にエラー |
| カート内の価格が変更された | カート追加時の価格で注文 |

---

## テスト自動化への活用

### Cucumberでの実装例

```ruby
# features/book_search.feature
Feature: 書籍検索・閲覧

  Scenario: カテゴリで書籍を絞り込む
    Given ユーザーが書籍検索画面にアクセスしている
    When ユーザーがカテゴリ「Java」を選択して検索する
    Then Java カテゴリの書籍一覧が表示される
    And 各書籍には書籍名、著者、出版社、価格、在庫数が表示される
```

### Seleniumでの実装例

```java
@Test
public void testSearchByCategory() {
    // Given
    driver.get("http://localhost:8080/berry-books/bookSearch.xhtml");
    
    // When
    Select categorySelect = new Select(driver.findElement(By.id("category")));
    categorySelect.selectByVisibleText("Java");
    driver.findElement(By.id("searchButton")).click();
    
    // Then
    List<WebElement> books = driver.findElements(By.cssSelector(".book-item"));
    assertTrue(books.size() > 0);
    // 各書籍の表示項目を検証...
}
```

---

**ドキュメント終了**

*この振る舞い仕様は、システムの外形的な動作を定義し、ブラックボックステストの基礎となります。テスト自動化ツール（Cucumber、SpecFlow、Selenium等）で直接活用できます。*
